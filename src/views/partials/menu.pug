doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1.0")
    title Myth Journey – Page 1

    // Fonts
    link(rel="preconnect", href="https://fonts.googleapis.com")
    link(rel="preconnect", href="https://fonts.gstatic.com", crossorigin)
    link(
      href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@100..900&display=swap",
      rel="stylesheet"
    )

    // Main CSS
    link(rel="stylesheet", href="assets/css/style.css")

    // Font Awesome
    link(
      rel="stylesheet",
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    )

    // GSAP
    script(src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js")

    style.
      .logo-container.fixed {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 999;
      }

  body.page1
    // =======================
    // LOGO CONTAINER
    // =======================
    .logo-container
      img.logo-trigger.logo1(src="/images/red-arrow-logo.png", alt="Red Logo")

    // =======================
    // OVERLAY
    // =======================
    .overlay
      .outer
        .top-icon.arrow
          img(src="/images/menu-arrow.png", alt="Close")

        .stage#stage
          .carousel#carousel
            each item, index in menuItems
              - const isMain = index === 0
              - const displayOrder = item.data.order || (index + 1)
              .item(
                class=isMain ? 'main' : 'side'
                data-route=item.data.route[0].text
                data-label=item.data.label.map(b => b.text).join(' ')
              )
                span (#{String(displayOrder).padStart(2, '0')})
                each block in item.data.label
                  | #{block.text}
                  br

        .social-icons
          span
            a(href="https://www.facebook.com/StudioRedArrow/")
              img(src="/images/facebook-icon.png", alt="Facebook")
          span
            a(href="https://www.linkedin.com/company/red-arrow-limited")
              img(src="/images/linkdin-icon.png", alt="LinkedIn")
          span
            a(href="https://www.instagram.com/studioredarrow/")
             img(src="/images/instagram-icon.png", alt="Instagram")

    script.
      // =======================
      // CLICK TO MOVE THE SLIDER
      // =======================
      const carousel = document.getElementById('carousel');
      const items = carousel.querySelectorAll('.item');

      const sensitivity = 0.25;
      const itemCount = items.length;
      const translateZ = 450;
      
      // Track which item is currently centered (0-indexed)
      let centeredIndex = 0;
      
      // Position items so only 3 are visible: prev (-60°), current (0°), next (60°)
      // Other items go to back (180°) to hide them
      function repositionItems(centerIdx) {
        const prevIdx = (centerIdx - 1 + itemCount) % itemCount;
        const nextIdx = (centerIdx + 1) % itemCount;
        
        items.forEach((item, index) => {
          let angle;
          if (index === centerIdx) {
            angle = 0;  // Center
            item.classList.add('main');
            item.classList.remove('side');
          } else if (index === prevIdx) {
            angle = -60;  // Left side (previous)
            item.classList.add('side');
            item.classList.remove('main');
          } else if (index === nextIdx) {
            angle = 60;   // Right side (next)
            item.classList.add('side');
            item.classList.remove('main');
          } else {
            angle = 180;  // Hidden at back
            item.classList.add('side');
            item.classList.remove('main');
          }
          item.style.transform = `rotateY(${angle}deg) translateZ(${translateZ}px)`;
        });
      }
      
      // Apply initial positioning with item 0 centered
      repositionItems(0);

      // Function to check if an item is currently centered
      function isItemCentered(item) {
        return item.classList.contains('main');
      }

      // Click event listener for each item
      document.querySelectorAll('.carousel .item').forEach(item => {
        item.addEventListener('click', (e) => {
          const route = item.dataset.route;
          const label = item.dataset.label;

          // Check if the clicked item is already centered
          const isCentered = isItemCentered(item);
          const itemIndex = Array.from(items).indexOf(item);

          if (isCentered) {
            // Navigate to the page
            console.log('NAVIGATING →', label);
            setTimeout(() => {
              window.location.replace(
                `/loading?to=${encodeURIComponent(route)}&label=${encodeURIComponent(label)}`
              );
            }, 100);
          } else {
            // Center this item and reposition all items
            console.log('SCROLLING TO CENTER →', label);
            centeredIndex = itemIndex;
            
            // Add transition to items for smooth animation
            items.forEach(i => {
              i.style.transition = 'transform 0.8s cubic-bezier(0.23,1,0.32,1)';
            });
            
            repositionItems(centeredIndex);
          }
        });
      });

      // Initialize the carousel (no rotation on container needed)
      carousel.style.transform = `rotateY(0deg)`;

      // =======================
      // OVERLAY OPEN / CLOSE
      // =======================
      const overlay = document.querySelector('.overlay');
      const logo = document.querySelector('.logo1');
      const arrow = document.querySelector('.arrow img');

      gsap.set(overlay, { y: "100%", display: "none" });

      // Get progress bar wrapper (used on portfolio page)
      const progressBarWrapper = document.querySelector('.progress-bar-wrapper');

      logo.addEventListener('click', () => {
        overlay.style.display = "block";
        gsap.to(overlay, { y: 0, duration: 1, ease: "power4.out" });
        // Hide progress bar when menu opens
        if (progressBarWrapper) {
          progressBarWrapper.style.display = "none";
        }
      });

      arrow.addEventListener('click', () => {
        gsap.to(overlay, {
          y: "100%",
          duration: 1,
          ease: "power4.in",
          onComplete: () => {
            overlay.style.display = "none";
            // Show progress bar when menu closes
            if (progressBarWrapper) {
              progressBarWrapper.style.display = "block";
            }
          }
        });
      });

      // =======================
      // LOGO SCROLL SHOW / HIDE + FIXED POSITION
      // =======================
      const logoContainer = document.querySelector('.logo-container');

      let lastScrollY = window.scrollY;
      const scrollThreshold = 10;

      gsap.set(logoContainer, { y: 0, opacity: 1 });

      window.addEventListener('scroll', () => {
        const currentScrollY = window.scrollY;

        if (Math.abs(currentScrollY - lastScrollY) < scrollThreshold) return;

        if (currentScrollY > lastScrollY && currentScrollY > 50) {
          logoContainer.classList.remove('fixed');
          gsap.to(logoContainer, {
            y: -100,
            opacity: 0,
            duration: 0.4,
            ease: "power3.out"
          });
        } else {
          logoContainer.classList.add('fixed');
          gsap.to(logoContainer, {
            y: 0,
            opacity: 1,
            duration: 0.4,
            ease: "power3.out"
          });
        }

        lastScrollY = currentScrollY;
      });