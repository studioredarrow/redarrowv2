extends ../layout

//- block variables
//-   - var headerWhite = true
//-   - var pageClass = 'terms-page'

block content
  .term-outer
    // ===== PROGRESS BAR =====
    .progress-bar-wrapper
      .progress-bar

    .container
      // ===== PAGE HEADER =====
      .header-inner
        h1.animate-text= terms.data.page_title

      // ===== MOBILE TOGGLE BUTTON =====
      //- .term-toggle
      //-   button#termsToggle
      //-     span.text Show Terms
      //-     span.icon +

      // ===== TERMS CONTENT =====
      .terms-container

        // ===== TABLE OF CONTENTS =====
        .toc
          h2.animate-text Table of Contents
          ul
            each section, index in terms.data.sections
              li
                a.animate-text.toc-link(
                  href=`#section-${index}`
                  data-target=`section-${index}`
                )= section.section_title

        // ===== TERMS SECTIONS =====
        .term-section
          each section, index in terms.data.sections
            h2.animate-text(id=`section-${index}`)= section.section_title

            each block in section.section_content
              if block.type === "paragraph"
                p.animate-text= block.text

  // ================= SCRIPTS =================
  script(src="https://cdn.jsdelivr.net/npm/gsap@3/dist/gsap.min.js")
  script(src="https://cdn.jsdelivr.net/npm/gsap@3/dist/ScrollTrigger.min.js")

  script.
    document.addEventListener("DOMContentLoaded", function () {
      if (!window.gsap || !window.ScrollTrigger) return;

      gsap.registerPlugin(ScrollTrigger);

      // ===== PROGRESS BAR =====
      gsap.to(".progress-bar", {
        scaleX: 1,
        ease: "none",
        scrollTrigger: {
          start: 0,
          end: () => document.documentElement.scrollHeight - window.innerHeight,
          scrub: true
        }
      });

      // ===== TEXT ANIMATION =====
      gsap.utils.toArray(".animate-text").forEach((elem, i) => {
        gsap.from(elem, {
          opacity: 0,
          y: 50,
          scale: 0.95,
          duration: 0.8,
          ease: "power3.out",
          scrollTrigger: {
            trigger: elem,
            start: "top 85%",
            toggleActions: "play none none none"
          },
          delay: i * 0.05
        });
      });

      // ===== MOBILE SINGLE TOGGLE =====
      //- if (window.innerWidth <= 768) {
      //-   const toggleBtn = document.getElementById("termsToggle");
      //-   const content = document.getElementById("termsContent");
      //-   const icon = toggleBtn.querySelector(".icon");
      //-   const text = toggleBtn.querySelector(".text");

      //-   toggleBtn.addEventListener("click", () => {
      //-     content.classList.toggle("open");
      //-     const isOpen = content.classList.contains("open");
      //-     icon.textContent = isOpen ? "âˆ’" : "+";
      //-     text.textContent = isOpen ? "Hide Terms" : "Show Terms";
      //-   });
      //- }

      // ===== TOC CLICK SCROLL =====
      document.querySelectorAll(".toc-link").forEach(link => {
        link.addEventListener("click", e => {
          e.preventDefault();
          const targetId = link.dataset.target;
          const targetEl = document.getElementById(targetId);

          if (!targetEl) return;

          window.scrollTo({
            top: targetEl.offsetTop - 80, // adjust for header height
            behavior: "smooth"
          });
        });
      });

      // ===== TOC ACTIVE STATE ON SCROLL =====
      gsap.utils.toArray(".term-section h2").forEach((section, index) => {
        ScrollTrigger.create({
          trigger: section,
          start: "top center",
          onEnter: () => setActive(index),
          onEnterBack: () => setActive(index)
        });
      });

      function setActive(index) {
        document.querySelectorAll(".toc-link").forEach((link, i) => {
          link.classList.toggle("active", i === index);
        });
      }
    });
