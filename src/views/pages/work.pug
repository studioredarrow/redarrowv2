extends ../layout

block content
  .main-work-outer
    .work-outer
      .container
        .work-flex
          .toggle
            button#gridBtn.active Grid
            button#listBtn List

          .category-links
            span.category.active(data-filter="all") all brand identity 
              span.count (9)
            | ,
            span.category(data-filter="app-website") app & website 
              span.count (8)
            | ,
            span.category(data-filter="exhibition") exhibitions 
              span.count (5)
            | ,
            span.category(data-filter="product-design") product design 
              span.count (3)
            | ,
            span.category(data-filter="packaging") packaging 
              span.count (8)
            | ,
            span.category(data-filter="environment-design") environment design 
              span.count (4)
            | ,
            span.category(data-filter="brand-amplification") brand amplification 
              span.count (8)
            | ,
            span.category(data-filter="bdc") BDC 
              span.count (8)
            .absolute-image 
              img(src="/images/category-image.png", alt="")  

        // GRID VIEW
        #gridView.grid.active
          each item in workItems
            .card(
              data-category=item.data.category || 'all'
            )
              if item.data.thumbnail
                .main-grid-img 
                  img(src=item.data.thumbnail.url, alt=item.data.title)
              .card-title= item.data.title
              .card-desc= item.data.short_description


        // FIXED IMAGE PREVIEW
        #imagePreview

        // LIST VIEW
        #listView.list
          .canvas
            each item, index in workItems
              .text(
                data-category=item.data.category || 'all'
                data-image=item.data.thumbnail ? item.data.thumbnail.url : ''
              )= item.data.title



    script(src="https://unpkg.com/gsap@3/dist/gsap.min.js")
    script(src="https://unpkg.com/gsap@3/dist/ScrollTrigger.min.js")

    script.
      document.addEventListener("DOMContentLoaded", () => {

        const gridBtn = document.getElementById("gridBtn");
        const listBtn = document.getElementById("listBtn");
        const gridView = document.getElementById("gridView");
        const listView = document.getElementById("listView");
        const categories = document.querySelectorAll(".category");
        const cards = document.querySelectorAll(".card");
        const texts = document.querySelectorAll(".text");
        const imagePreview = document.getElementById("imagePreview");

        /* ---------------- TEXT ANIMATION ---------------- */
        function animateTexts(textElements) {
          gsap.fromTo(
            textElements,
            { y: 20, opacity: 0 },
            { y: 0, opacity: 1, duration: 0.8, stagger: 0.1, ease: "power3.out" }
          );
        }

        /* ---------------- INSTANT IMAGE HIDE ---------------- */
        function hideImagePreviewInstant() {
          gsap.killTweensOf(imagePreview);
          gsap.set(imagePreview, {
            opacity: 0,
            scale: 0.95
          });
        }

        /* ---------------- VIEW TOGGLE ---------------- */
        gridBtn.onclick = () => {
          gridView.classList.add("active");
          listView.classList.remove("active");
          gridBtn.classList.add("active");
          listBtn.classList.remove("active");

          hideImagePreviewInstant();

          texts.forEach(t => {
            t.classList.remove("active", "blur");
            gsap.set(t, { y: 0, opacity: 1 });
          });

          gsap.fromTo(
            cards,
            { y: 40, opacity: 0 },
            { y: 0, opacity: 1, duration: 0.8, stagger: 0.1 }
          );

          animateTexts(texts);
        };

        listBtn.onclick = () => {
          listView.classList.add("active");
          gridView.classList.remove("active");
          listBtn.classList.add("active");
          gridBtn.classList.remove("active");

          hideImagePreviewInstant();
          animateTexts(texts);
        };

        /* ---------------- CATEGORY FILTER ---------------- */
        categories.forEach(cat => {
          cat.addEventListener("click", () => {
            categories.forEach(c => c.classList.remove("active"));
            cat.classList.add("active");

            const filter = cat.dataset.filter;

            cards.forEach(card => {
              card.style.display =
                filter === "all" || card.dataset.category === filter
                  ? "block"
                  : "none";
            });

            texts.forEach(text => {
              text.style.display =
                filter === "all" || text.dataset.category === filter
                  ? "block"
                  : "none";
            });

            hideImagePreviewInstant();

            gsap.fromTo(
              [...cards, ...texts].filter(el => el.style.display !== "none"),
              { y: 40, opacity: 0 },
              { y: 0, opacity: 1, duration: 0.6, stagger: 0.06 }
            );
          });
        });

        /* ---------------- TEXT POSITION ---------------- */
        const pattern = [
          { left: 120, top: 70 },
          { left: 120, top: 140 },
          { right: 180, top: 200 },
          { left: 360, top: 260 },
          { left: 120, top: 330 },
          { right: 240, top: 390 },
          { left: 260, top: 460 }
        ];

        texts.forEach((text, index) => {
          const pos = pattern[index % pattern.length];
          text.style.top = `${pos.top + Math.floor(index / pattern.length) * 520}px`;

          if (pos.left !== undefined) {
            text.style.left = `${pos.left}px`;
            text.style.right = "auto";
          }

          if (pos.right !== undefined) {
            text.style.right = `${pos.right}px`;
            text.style.left = "auto";
          }
        });

        /* ---------------- HOVER IMAGE PREVIEW ---------------- */
        texts.forEach(text => {

          const img = text.dataset.image;

          text.addEventListener("mouseenter", () => {
            texts.forEach(t => {
              t.classList.remove("active");
              t.classList.add("blur");
            });

            text.classList.add("active");
            text.classList.remove("blur");

            if (!img) return;

            imagePreview.style.backgroundImage = `url(${img})`;

            gsap.set(imagePreview, {
              left: "50%",
              top: "50%",
              x: "-50%",
              y: "-50%",
              scale: 1,
              opacity: 1
            });
          });

          /* ðŸ”¥ INSTANT REMOVE ON LEAVE */
          text.addEventListener("mouseleave", () => {
            hideImagePreviewInstant();
            texts.forEach(t => t.classList.remove("active", "blur"));
          });

          /* ðŸ”¥ INSTANT REMOVE ON CLICK */
          text.addEventListener("click", () => {
            hideImagePreviewInstant();
          });
        });

        /* ---------------- INITIAL ---------------- */
        hideImagePreviewInstant();
        animateTexts(texts);

      });

    script.
      document.addEventListener("DOMContentLoaded", () => {

        gsap.registerPlugin(ScrollTrigger);

        gsap.defaults({
          duration: 0.9,
          ease: "power3.out"
        });

        /* =========================
          GRID IMAGE REVEAL
        ========================= */
        function animateGridImages() {
          gsap.utils.toArray(".main-grid-img img").forEach(img => {
            gsap.from(img, {
              scrollTrigger: {
                trigger: img,
                start: "top 85%"
              },
              scale: 1.1,
              opacity: 0
            });
          });
        }

        /* =========================
          GRID TEXT REVEAL
        ========================= */
        function animateGridText() {
          gsap.utils.toArray(".card-title, .card-desc").forEach(el => {
            gsap.from(el, {
              scrollTrigger: {
                trigger: el,
                start: "top 85%"
              },
              y: 40,
              opacity: 0
            });
          });
        }

        /* =========================
          REFRESH ALL ANIMATIONS
        ========================= */
        function refreshAnimations() {
          ScrollTrigger.getAll().forEach(st => st.kill());
          animateGridImages();
          animateGridText();
          ScrollTrigger.refresh();
        }

        /* =========================
          INITIAL LOAD
        ========================= */
        refreshAnimations();

        /* =========================
          VIEW TOGGLE
        ========================= */
        const gridBtn = document.getElementById("gridBtn");
        const listBtn = document.getElementById("listBtn");

        if (gridBtn && listBtn) {
          gridBtn.addEventListener("click", () => {
            setTimeout(refreshAnimations, 50);
          });

          listBtn.addEventListener("click", () => {
            setTimeout(refreshAnimations, 50);
          });
        }

        /* =========================
          CATEGORY FILTER
        ========================= */
        document.querySelectorAll(".category").forEach(cat => {
          cat.addEventListener("click", () => {
            setTimeout(refreshAnimations, 50);
          });
        });

      });


    
    script.
      document.addEventListener("DOMContentLoaded", () => {

        gsap.registerPlugin(ScrollTrigger);

        gsap.defaults({
          duration: 0.8,
          ease: "power3.out"
        });

        /* =========================
          CATEGORY LINKS ANIMATION (staggered)
        ========================= */
        const categoryEls = document.querySelectorAll(".category-links .category");

        gsap.from(categoryEls, {
          scrollTrigger: {
            trigger: ".category-links",
            start: "top 90%", // when container comes into view
          },
          y: 40,
          opacity: 0,
          stagger: 0.1
        });

      });
