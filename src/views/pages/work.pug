extends ../layout

block content
  .main-work-outer
    .work-outer
      .container
        .inner-grid-flex
          img(src="/images/main-grid.png", alt="")
        .work-flex
          .toggle
            button#gridBtn.active Grid
            button#listBtn List

          .category-links
            span.category.active(data-filter="all") all
            | ,
            span.category(data-filter="brand-identity") brand identity 
              span.count (#{counts['brand-identity'] || 0})
            | ,
            span.category(data-filter="app-website") app & website 
              span.count (#{counts['app-website'] || 0})
            | ,
            span.category(data-filter="exhibition") exhibitions 
              span.count (#{counts['exhibition'] || 0})
            | ,
            span.category(data-filter="product-design") product design 
              span.count (#{counts['product-design'] || 0})
            | ,
            span.category(data-filter="packaging") packaging 
              span.count (#{counts['packaging'] || 0})
            | ,
            span.category(data-filter="environment-design") environment design 
              span.count (#{counts['environment-design'] || 0})
            | ,
            span.category(data-filter="brand-amplification") brand amplification 
              span.count (#{counts['brand-amplification'] || 0})
            | ,
            span.category(data-filter="bdc") BDC 
              span.count (#{counts['bdc'] || 0})
            .absolute-image 
              img(src="/images/category-image.png", alt="")
              
          style.
            .category.active .count {
              color: inherit;
              opacity: 1;
            }
            .category .count {
              opacity: 0.6;
              transition: opacity 0.3s ease;
            }

        // GRID VIEW
        #gridView.grid.active
          each item, index in workItems
            - var rowIndex = Math.floor(index / 2)
            - var positionInRow = index % 2
            - var gapPosition = rowIndex % 3
            - var gridColClass = ''
            - if (gapPosition === 0) {
            -   // Row 1: card1, card2, gap (cards in cols 1-2 and 3-4, gap in col 5)
            -   gridColClass = positionInRow === 0 ? 'col-1' : 'col-3'
            - } else if (gapPosition === 1) {
            -   // Row 2: card1, gap, card2 (card1 in cols 1-2, gap in col 3, card2 in cols 4-5)
            -   gridColClass = positionInRow === 0 ? 'col-1' : 'col-4'
            - } else {
            -   // Row 3: gap, card1, card2 (gap in col 1, cards in cols 2-3 and 4-5)
            -   gridColClass = positionInRow === 0 ? 'col-5' : 'col-4'
            - }
            .card(
              class=gridColClass
              data-category=item.data.category || 'all'
              onclick=`window.location.href='/portfolio/${item.uid}'`
              style="cursor: pointer;"
            )
              if item.data.thumbnail
                .main-grid-img 
                  img(src=item.data.thumbnail.url, alt=item.data.title)
              .card-title= item.data.title
              .card-desc= item.data.short_description


        // FIXED IMAGE PREVIEW
        #imagePreview

        // LIST VIEW
        #listView.list
          .canvas
            each item, index in workItems
              .text(
                data-category=item.data.category || 'all'
                data-image=item.data.thumbnail ? item.data.thumbnail.url : ''
                onclick=`window.location.href='/portfolio/${item.uid}'`
                style="cursor: pointer;"
              )= item.data.title


    script(src="https://unpkg.com/gsap@3/dist/gsap.min.js")
    script(src="https://unpkg.com/gsap@3/dist/ScrollTrigger.min.js")

    script.
      document.addEventListener("DOMContentLoaded", () => {
        gsap.registerPlugin(ScrollTrigger);

        // --- Elements ---
        const gridBtn = document.getElementById("gridBtn");
        const listBtn = document.getElementById("listBtn");
        const gridView = document.getElementById("gridView");
        const listView = document.getElementById("listView");
        const categoryBtns = document.querySelectorAll(".category-links .category");
        const imagePreview = document.getElementById("imagePreview");
        
        // Items
        let cards = document.querySelectorAll(".card");
        let listItems = document.querySelectorAll(".text");

        // --- Config ---
        const gsapDefaults = { duration: 0.8, ease: "power3.out" };
        gsap.defaults(gsapDefaults);

        // --- Helper: Hide Image Preview ---
        function hideImagePreviewInstant() {
          if (!imagePreview) return;
          gsap.killTweensOf(imagePreview);
          gsap.set(imagePreview, { opacity: 0, scale: 0.95, display: 'none' });
        }

        // --- Helper: Refresh ScrollTrigger ---
        function refreshScrollTrigger() {
          ScrollTrigger.refresh();
        }

        // --- Animation: Initial/Re-entry ---
        function animateContainer(elements) {
          if (!elements.length) return;
          gsap.fromTo(elements, 
            { y: 30, opacity: 0 },
            { y: 0, opacity: 1, duration: 0.6, stagger: 0.05, clearProps: "transform,opacity" }
          );
        }

        // --- Animation: Categories ---
        function animateCategories() {
          gsap.from(categoryBtns, {
            y: 30, opacity: 0, stagger: 0.05, duration: 0.6, delay: 0.2
          });
        }

        // --- Core: Filtering ---
        function applyFilter(category) {
          const filterVal = category.trim().toLowerCase();
          
          // Filter Grid Cards
          let visibleCards = [];
          cards.forEach(card => {
            const cardCat = (card.dataset.category || "all").trim().toLowerCase();
            if (filterVal === "all" || cardCat === filterVal) {
              card.style.display = "block";
              visibleCards.push(card);
            } else {
              card.style.display = "none";
            }
          });

          // Filter List Items
          let visibleTexts = [];
          listItems.forEach(item => {
            const itemCat = (item.dataset.category || "all").trim().toLowerCase();
            if (filterVal === "all" || itemCat === filterVal) {
              item.style.display = "block";
              visibleTexts.push(item);
            } else {
              item.style.display = "none";
            }
          });

          // Re-run animations on visible elements and resize containers
          const isGrid = gridView.classList.contains("active");
          if (isGrid) {
            animateContainer(visibleCards);
          } else {
            animateContainer(visibleTexts);
            repositionListItems(visibleTexts);
          }
          
          // Ensure footer isn't floating in space if content is short
          // The CSS should handle min-height, but let's encourage it.
          
          setTimeout(refreshScrollTrigger, 100); 
        }

        // --- Core: Logic for List View Positioning ---
        function repositionListItems(visibleItems) {
           const pattern = [
            { left: 120, top: 70 },
            { left: 240, top: 165 },
            { right: 40, top: 255 },
            { left: 360, top: 350 },
            { left: 120, top: 450 },
            { right: 250, top: 530 },
            { left: 260, top: 610 }
          ];
          
          let maxTop = 0;
          const cycleHeight = 630;

          visibleItems.forEach((text, index) => {
             const pos = pattern[index % pattern.length];
             // Reset
             text.style.left = '';
             text.style.right = '';
             text.style.top = '';

             const calculatedTop = pos.top + Math.floor(index / pattern.length) * cycleHeight;
             text.style.top = `${calculatedTop}px`;
             
             if (calculatedTop > maxTop) maxTop = calculatedTop;

             if (pos.left !== undefined) {
               text.style.left = `${pos.left}px`;
               text.style.right = "auto";
             } else if (pos.right !== undefined) {
               text.style.right = `${pos.right}px`;
               text.style.left = "auto";
             }
          });
          
          // Adjust container height
          if (visibleItems.length > 0) {
            // Add some padding ~ 150px
            listView.style.minHeight = (maxTop + 200) + 'px';
            listView.style.height = 'auto'; // ensure it expands
          } else {
             listView.style.minHeight = '50vh'; 
          }
        }

        // --- Event Listeners: Category Buttons ---
        categoryBtns.forEach(btn => {
          btn.addEventListener("click", () => {
             if(btn.classList.contains('active')) return;

            categoryBtns.forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            
            const filter = btn.dataset.filter;
            applyFilter(filter);
          });
        });

        // --- Event Listeners: View Toggles ---
        if (gridBtn && listBtn) {
          gridBtn.addEventListener("click", () => {
            if (gridBtn.classList.contains("active")) return;
            
            gridBtn.classList.add("active");
            listBtn.classList.remove("active");
            
            gridView.classList.add("active");
            listView.classList.remove("active");
            
            hideImagePreviewInstant();
            
            const activeCatBtn = document.querySelector(".category-links .category.active");
            const currentFilter = activeCatBtn ? activeCatBtn.dataset.filter : "all";
            applyFilter(currentFilter);
          });

          listBtn.addEventListener("click", () => {
            if (listBtn.classList.contains("active")) return;
            
            listBtn.classList.add("active");
            gridBtn.classList.remove("active");
            
            listView.classList.add("active");
            gridView.classList.remove("active");
            
            hideImagePreviewInstant();
            
            const activeCatBtn = document.querySelector(".category-links .category.active");
            const currentFilter = activeCatBtn ? activeCatBtn.dataset.filter : "all";
            applyFilter(currentFilter);
          });
        }

        // --- Hover Effects for List Items ---
        const imagePositionPattern = ["left", "right", "center"];
        listItems.forEach((text, index) => {
          const imgUrl = text.dataset.image;
          // Use stable index logic? 
          // The hover animation position logic in original code depended on original index.
          // Let's stick to simple cycle.
          const pos = imagePositionPattern[index % imagePositionPattern.length];

          text.addEventListener("mouseenter", () => {
            if (!listView.classList.contains("active")) return; 
            
            listItems.forEach(t => {
               if (t !== text && t.style.display !== 'none') {
                 t.classList.add("blur");
                 t.classList.remove("active");
               }
            });
            text.classList.remove("blur");
            text.classList.add("active");

            if (imgUrl && imagePreview) {
               imagePreview.style.backgroundImage = `url(${imgUrl})`;
               imagePreview.style.display = 'block';

               let leftVal = "50%";
               if (pos === "left") leftVal = "20%";
               if (pos === "right") leftVal = "80%";
               
               gsap.to(imagePreview, {
                 duration: 0.4,
                 left: leftVal,
                 top: "50%",
                 x: "-50%",
                 y: "-50%",
                 scale: 1,
                 opacity: 1
               });
            }
          });

          text.addEventListener("mouseleave", () => {
             hideImagePreviewInstant();
             listItems.forEach(t => t.classList.remove("blur", "active"));
          });
        });

        // --- Init ---
        animateCategories();

        // Check for URL param ?category=...
        const urlParams = new URLSearchParams(window.location.search);
        const urlMethod = urlParams.get("category");
        
        if (urlMethod) {
          // Find matching button to set active state
          const targetBtn = Array.from(categoryBtns).find(btn => btn.dataset.filter === urlMethod.trim().toLowerCase());
          
          if (targetBtn) {
            categoryBtns.forEach(b => b.classList.remove("active"));
            targetBtn.classList.add("active");
            applyFilter(urlMethod);
          } else {
            // If invalid category or not found, default to all
            applyFilter("all");
          }
        } else {
          // Default: all
          applyFilter("all");
        }
        
        window.addEventListener("load", refreshScrollTrigger);
      });
