extends ../layout

block content
  .studio-main-outer
    .page-wrapper(
      data-studio-images=JSON.stringify(studioImages.data.images_for_24_hours)
    )
      .details
        .details-item
          span.label Location
          span#saigon SAIGON 
        .details-item
          span.label Time
          span#saigonTime 7:00 AM
        
    .work-outer.open-outer
      .container
        .inner-grid-flex.studio-open
          img(src="/images/main-grid.png", alt="")
        .work-flex.open-flex
          .toggle
            button#gridBtn.active Grid
            button#listBtn List

      .container
        #gridView.grid.active
          //- Use exhibitions array from studioImages (expecting data.exhibitions)
          if studioImages.data.exhibitions && studioImages.data.exhibitions.length
            each item, index in studioImages.data.exhibitions
              - var rowIndex = Math.floor(index / 2)
              - var positionInRow = index % 2
              - var gapPosition = rowIndex % 3
              - var gridColClass = ''
              - if (gapPosition === 0) {
              -   gridColClass = positionInRow === 0 ? 'col-1' : 'col-3'
              - } else if (gapPosition === 1) {
              -   gridColClass = positionInRow === 0 ? 'col-1' : 'col-4'
              - } else {
              -   gridColClass = positionInRow === 0 ? 'col-5' : 'col-4'
              - }
              //- No clickable link requested for now, or use "#"
              .card(
                class=gridColClass
                style="cursor: default;"
              )
                if item.image && item.image.url
                  .main-grid-img 
                    img(src=item.image.url, alt=item.artist_name || 'Exhibition Image')
                
                //- New Flex Container
                .card-bottom(style="display: flex; justify-content: space-between;")
                  if item.artist_name
                    .card-title= item.artist_name
                  if item.year
                    .card-desc= item.year

        // FIXED IMAGE PREVIEW
        #imagePreview

        // LIST VIEW
        #listView.list
          .canvas
            if studioImages.data.exhibitions && studioImages.data.exhibitions.length
              each item, index in studioImages.data.exhibitions
                .text(
                  data-image=item.image ? item.image.url : ''
                  style="cursor: default;"
                )= item.artist_name || 'Untitled'


        style.
            .logo-container {
              background-color: transparent !important;
            }
            .logo-container.fixed {
              background-color: transparent !important;
            }        

    script(src="https://unpkg.com/gsap@3/dist/gsap.min.js")
    script(src="https://unpkg.com/gsap@3/dist/ScrollTrigger.min.js")

    script.
      document.addEventListener("DOMContentLoaded", () => {

        gsap.registerPlugin(ScrollTrigger);

        const gridBtn = document.getElementById("gridBtn");
        const listBtn = document.getElementById("listBtn");
        const gridView = document.getElementById("gridView");
        const listView = document.getElementById("listView");
        const imagePreview = document.getElementById("imagePreview");
        
        const texts = document.querySelectorAll(".text");
        // We re-query cards/images inside logic usually? Or use references.
        // But since they are static for now:
        const cards = document.querySelectorAll(".card");
        const gridImages = document.querySelectorAll(".main-grid-img img");
        const gridTexts = document.querySelectorAll(".card-title, .card-desc, .card-bottom");


        /* ================= SAIGON REAL TIME ================= */
        const timeEl = document.getElementById("saigonTime");

        function updateSaigonTime() {
          if (!timeEl) return;
          const now = new Date();
          const formatter = new Intl.DateTimeFormat("en-US", {
            timeZone: "Asia/Ho_Chi_Minh",
            hour: "numeric",
            minute: "2-digit",
            hour12: true
          });
          timeEl.textContent = formatter.format(now);
        }
        updateSaigonTime();
        setInterval(updateSaigonTime, 60 * 1000);

        /* ================= OPEN STUDIO BACKGROUND ================= */
        const pageWrapper = document.querySelector(".page-wrapper");

        function updateStudioBackground() {
          if (!pageWrapper || !pageWrapper.dataset.studioImages) return;
          let studioImages;
          try {
            studioImages = JSON.parse(pageWrapper.dataset.studioImages);
          } catch (e) {
            return;
          }

          const now = new Date();
          const hour = Number(
            new Intl.DateTimeFormat("en-US", {
              timeZone: "Asia/Ho_Chi_Minh",
              hour: "numeric",
              hour12: false
            }).format(now)
          );
          const hourCount = hour + 1; // 0 → 1, 13 → 14

          const currentEntry = studioImages.find(
            img => Number(img.hour_count) === hourCount
          );

          if (!currentEntry) return;

          const isMobile = window.innerWidth <= 768;
          const desktopImage = currentEntry.image_for_desktop || currentEntry.imagr_for_desktop;
          const bgImage = isMobile
            ? currentEntry.image_for_mobile?.url
            : desktopImage?.url;

          if (!bgImage) return;

          pageWrapper.style.backgroundImage = `url(${bgImage})`;
          pageWrapper.style.backgroundSize = "cover";
          pageWrapper.style.backgroundPosition = "center";
          pageWrapper.style.backgroundRepeat = "no-repeat";
        }
        updateStudioBackground();
        setInterval(updateStudioBackground, 60 * 1000);

        /* ================= ANIMATION & VIEW TOGGLE ================= */
        
        // --- 1. Animation Functions ---
        
        function animateTexts(textElements) {
          if(!textElements.length) return;
          // Ensure they are visible before animating
           gsap.set(textElements, { display: 'block', opacity: 0, y: 20 });
           
           gsap.to(textElements, { 
             y: 0, 
             opacity: 1, 
             duration: 0.8, 
             stagger: 0.1, 
             ease: "power3.out",
             onStart: () => {
                // Ensure parent container is active
                listView.classList.add("active");
             } 
           });
        }
        
        function animateGridEntrance() {
          // Animate cards staggering in
          // Ensure children inside cards are visible 
          gsap.set(gridTexts, { opacity: 1, y: 0, clearProps: 'all' });
          gsap.set(gridImages, { opacity: 1, scale: 1, clearProps: 'all' });
          
          gsap.fromTo(cards, 
             { y: 40, opacity: 0 },
             { y: 0, opacity: 1, duration: 0.8, stagger: 0.1, ease: "power3.out" }
          );
        }

        // --- 2. Initial ScrollTrigger Setup (Only runs on Load) ---
         // If we switch views, we might kill these triggers or refresh them.
        function initScrollTriggers() {
           // We only want these triggers if we are in Grid mode initially?
           // Actually, if we just want entrance animations on scroll:
           
           ScrollTrigger.getAll().forEach(st => st.kill());
           
           // Grid Images
           gsap.utils.toArray(".main-grid-img img").forEach(img => {
             gsap.from(img, {
               scrollTrigger: {
                 trigger: img,
                 start: "top 90%"
               },
               scale: 1.1,
               opacity: 0,
               duration: 0.9,
               ease: "power3.out"
             });
           });
           
           // Grid Text
           gsap.utils.toArray(".card-title, .card-desc, .card-bottom").forEach(el => {
             gsap.from(el, {
               scrollTrigger: {
                 trigger: el,
                 start: "top 90%"
               },
               y: 30,
               opacity: 0,
               duration: 0.9,
               ease: "power3.out"
             });
           });
           
           ScrollTrigger.refresh();
        }

        // --- 3. View Toggle Logic ---
        
        function hideImagePreviewInstant() {
          gsap.killTweensOf(imagePreview);
          gsap.set(imagePreview, { opacity: 0, scale: 0.95 });
        }

        if (gridBtn && listBtn) {
          
          gridBtn.onclick = () => {
            if (gridBtn.classList.contains("active")) return;
            
            // Switch State
            gridBtn.classList.add("active");
            listBtn.classList.remove("active");
            gridView.classList.add("active");
            listView.classList.remove("active");
            
            hideImagePreviewInstant();

            // Reset List Animations
            gsap.killTweensOf(texts);
            
            // Show Grid
            // IMPORTANT: If we rely on ScrollTrigger for *initial* load, we need to be careful here.
            // If the user scrolls down, toggle -> list -> toggle -> grid.
            // We should just play a simple entrance animation for the visible set.
            // We can KILL all scrolltriggers to avoid them snapping things back to hidden.
            ScrollTrigger.getAll().forEach(st => st.kill());
            
            animateGridEntrance();
          };

          listBtn.onclick = () => {
             if (listBtn.classList.contains("active")) return;
             
             // Switch State
             listBtn.classList.add("active");
             gridBtn.classList.remove("active");
             listView.classList.add("active");
             gridView.classList.remove("active");
             
             hideImagePreviewInstant();
             
             // Reset Grid Animations
             gsap.killTweensOf(cards);
             
             // Show List
             animateTexts(texts);
          };
        }

        /* ================= INITIAL LOAD ================= */
        hideImagePreviewInstant();
        // Default is Grid View active
        // Initialize ScrollTriggers for the first load experience
        initScrollTriggers();

        
        /* ---------------- LIST VIEW HOVER EFFECTS ---------------- */
        const pattern = [
          { left: 120, top: 70 },
          { left: 240, top: 165 },
          { right: 40, top: 255 },
          { left: 360, top: 350 },
          { left: 120, top: 450 },
          { right: 250, top: 600 },
          { left: 260, top: 665 }
        ];

        texts.forEach((text, index) => {
          const pos = pattern[index % pattern.length];
          text.style.top = `${pos.top + Math.floor(index / pattern.length) * 470}px`;

          if (pos.left !== undefined) {
            text.style.left = `${pos.left}px`;
            text.style.right = "auto";
          }
          if (pos.right !== undefined) {
            text.style.right = `${pos.right}px`;
            text.style.left = "auto";
          }
          
          // Hover
          const img = text.dataset.image;
          const imagePositionPattern = ["left", "right", "center"];
          const imgPos = imagePositionPattern[index % imagePositionPattern.length];
          
          text.addEventListener("mouseenter", () => {
            if(!listView.classList.contains('active')) return;
            
            texts.forEach(t => { 
                if(t !== text) { t.classList.remove("active"); t.classList.add("blur"); }
            });
            text.classList.add("active");
            text.classList.remove("blur");

            if (img) {
              imagePreview.style.backgroundImage = `url(${img})`;
              let left = "50%";
              if (imgPos === "left") left = "20%";
              if (imgPos === "right") left = "80%";

              gsap.to(imagePreview, {
                left, top: "50%", x: "-50%", y: "-50%",
                scale: 1, opacity: 1, duration: 0.4
              });
            }
          });
          
          text.addEventListener("mouseleave", () => {
             hideImagePreviewInstant();
             texts.forEach(t => t.classList.remove("active", "blur"));
          });
          
           text.addEventListener("click", () => {
            hideImagePreviewInstant();
          });
        });

      });

    //- Page animation
    script.
      gsap.registerPlugin(ScrollTrigger);

      gsap.defaults({
        duration: 1,
        ease: "power3.out"
      });

      // =========================
      // HERO ANIMATION
      // =========================
      const heroTL = gsap.timeline();
      heroTL
        .from(".image-container-unique img", { scale: 1.2, opacity: 0, duration: 1.4 })
        .from(".animate-text-unique", { y: 80, opacity: 0, stagger: 0.2 }, "-=0.8")
        .from(".banner-inner-unique ", { y: 60, opacity: 0, stagger: 0.2 }, "-=0.6");

      // =========================
      // TEXT REVEAL ON SCROLL
      // =========================
      gsap.utils.toArray(" h3, .card-title, .card-desc , img").forEach(el => {
        gsap.from(el, {
          scrollTrigger: {
            trigger: el,
            start: "top 70%"
          },
          y: 40,
          opacity: 0
        });
      });

      ScrollTrigger.refresh();
 
       