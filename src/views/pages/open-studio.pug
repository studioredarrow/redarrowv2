extends ../layout

block content
  .studio-main-outer
    .page-wrapper(
        data-morning=studioImages && studioImages.data && studioImages.data.morning ? studioImages.data.morning.url : ''
        data-afternoon=studioImages && studioImages.data && studioImages.data.afternoon ? studioImages.data.afternoon.url : ''
        data-evening=studioImages && studioImages.data && studioImages.data.evening ? studioImages.data.evening.url : ''
        data-night=studioImages && studioImages.data && studioImages.data.night ? studioImages.data.night.url : ''
    )
      .details
        .details-item
          span.label LOCATION
          span#saigon SAIGON 
        .details-item
          span.label TIME
          span#saigonTime 7:00 AM
        
    .work-outer.open-outer
      .container
        .work-flex.open-flex
          .toggle
            button#gridBtn.active Grid
            button#listBtn List

          .grid.grid-inner.active
            each item, index in workItems
              .card(
                data-category=item.data.category || 'all'
                onclick=`window.location.href='/portfolio/${item.uid}'`
                style="cursor: pointer;"
              )
                if item.data.thumbnail
                  .main-grid-img 
                    img(src=item.data.thumbnail.url, alt=item.data.title)
                .card-title= item.data.title
                .card-desc= item.data.short_description
  
            

      .container
        #gridView.grid.active
          each item, index in workItems
            .card(
              data-category=item.data.category || 'all'
              onclick=`window.location.href='/portfolio/${item.uid}'`
              style="cursor: pointer;"
            )
              if item.data.thumbnail
                .main-grid-img 
                  img(src=item.data.thumbnail.url, alt=item.data.title)
              .card-title= item.data.title
              .card-desc= item.data.short_description

        // FIXED IMAGE PREVIEW
        #imagePreview

        // LIST VIEW
        #listView.list
          .canvas
            each item, index in workItems
              .text(
                data-category=item.data.category || 'all'
                data-image=item.data.thumbnail ? item.data.thumbnail.url : ''
                onclick=`window.location.href='/portfolio/${item.uid}'`
                style="cursor: pointer;"
              )= item.data.title      

    script(src="https://unpkg.com/gsap@3/dist/gsap.min.js")
    script(src="https://unpkg.com/gsap@3/dist/ScrollTrigger.min.js")

    script.
      document.addEventListener("DOMContentLoaded", () => {

        gsap.registerPlugin(ScrollTrigger);

        const gridBtn = document.getElementById("gridBtn");
        const listBtn = document.getElementById("listBtn");
        const gridView = document.getElementById("gridView");
        const listView = document.getElementById("listView");
        const imagePreview = document.getElementById("imagePreview");
        const texts = document.querySelectorAll(".text");
        const cards = document.querySelectorAll(".card");

        /* ================= SAIGON REAL TIME ================= */
        const timeEl = document.getElementById("saigonTime");

        function updateSaigonTime() {
          if (!timeEl) return;

          const now = new Date();

          const formatter = new Intl.DateTimeFormat("en-US", {
            timeZone: "Asia/Ho_Chi_Minh",
            hour: "numeric",
            minute: "2-digit",
            hour12: true
          });

          timeEl.textContent = formatter.format(now);
        }

        // initial run
        updateSaigonTime();

        // update every minute (real-time feel)
        setInterval(updateSaigonTime, 60 * 1000);

        /* ================= OPEN STUDIO BACKGROUND ================= */
        const pageWrapper = document.querySelector(".page-wrapper");

        function updateStudioBackground() {
          if (!pageWrapper) return;

          const now = new Date();

          // Saigon hour (24h format)
          const hour = new Intl.DateTimeFormat("en-US", {
            timeZone: "Asia/Ho_Chi_Minh",
            hour: "numeric",
            hour12: false
          }).format(now);

          let bgImage = "";

          if (hour >= 5 && hour < 12) {
            bgImage = pageWrapper.dataset.morning;
          } else if (hour >= 12 && hour < 17) {
            bgImage = pageWrapper.dataset.afternoon;
          } else if (hour >= 17 && hour < 20) {
            bgImage = pageWrapper.dataset.evening;
          } else {
            bgImage = pageWrapper.dataset.night;
          }

          if (!bgImage) return;

          pageWrapper.style.backgroundImage = `url(${bgImage})`;
          pageWrapper.style.backgroundSize = "cover";
          pageWrapper.style.backgroundPosition = "center";
          pageWrapper.style.backgroundRepeat = "no-repeat";
        }

        // initial run
        updateStudioBackground();

        // update every minute (optional but nice)
        setInterval(updateStudioBackground, 60 * 1000);

        /* ---------------- TEXT ANIMATION ---------------- */
        function animateTexts(textElements) {
          gsap.fromTo(
            textElements,
            { y: 20, opacity: 0 },
            { y: 0, opacity: 1, duration: 0.8, stagger: 0.1, ease: "power3.out" }
          );
        }

        /* ---------------- INSTANT IMAGE HIDE ---------------- */
        function hideImagePreviewInstant() {
          gsap.killTweensOf(imagePreview);
          gsap.set(imagePreview, {
            opacity: 0,
            scale: 0.95
          });
        }

        /* ---------------- VIEW TOGGLE ---------------- */
        gridBtn.onclick = () => {
          gridView.classList.add("active");
          listView.classList.remove("active");
          gridBtn.classList.add("active");
          listBtn.classList.remove("active");

          hideImagePreviewInstant();

          texts.forEach(t => {
            t.classList.remove("active", "blur");
            gsap.set(t, { y: 0, opacity: 1 });
          });

          gsap.fromTo(
            cards,
            { y: 40, opacity: 0 },
            { y: 0, opacity: 1, duration: 0.8, stagger: 0.1 }
          );

          animateTexts(texts);
        };

        listBtn.onclick = () => {
          listView.classList.add("active");
          gridView.classList.remove("active");
          listBtn.classList.add("active");
          gridBtn.classList.remove("active");

          hideImagePreviewInstant();
          animateTexts(texts);
        };

        /* ---------------- TEXT POSITION ---------------- */
        const pattern = [
          { left: 120, top: 70 },
          { left: 120, top: 140 },
          { right: 180, top: 200 },
          { left: 360, top: 260 },
          { left: 120, top: 330 },
          { right: 240, top: 390 },
          { left: 260, top: 460 }
        ];

        texts.forEach((text, index) => {
          const pos = pattern[index % pattern.length];
          text.style.top = `${pos.top + Math.floor(index / pattern.length) * 470}px`;

          if (pos.left !== undefined) {
            text.style.left = `${pos.left}px`;
            text.style.right = "auto";
          }

          if (pos.right !== undefined) {
            text.style.right = `${pos.right}px`;
            text.style.left = "auto";
          }
        });

        /* ---------------- HOVER IMAGE PREVIEW ---------------- */
        const imagePositionPattern = ["left", "right", "center"];

        texts.forEach((text, index) => {

          const img = text.dataset.image;
          const pos = imagePositionPattern[index % imagePositionPattern.length];

          text.addEventListener("mouseenter", () => {
            texts.forEach(t => {
              t.classList.remove("active");
              t.classList.add("blur");
            });

            text.classList.add("active");
            text.classList.remove("blur");

            if (!img) return;

            imagePreview.style.backgroundImage = `url(${img})`;

            // default (center)
            let left = "50%";
            let x = "-50%";

            if (pos === "left") {
              left = "20%";
            }

            if (pos === "right") {
              left = "80%";
            }

            gsap.set(imagePreview, {
              left,
              top: "50%",
              x,
              y: "-50%",
              scale: 1,
              opacity: 1
            });
          });

          /* ðŸ”¥ INSTANT REMOVE ON LEAVE */
          text.addEventListener("mouseleave", () => {
            hideImagePreviewInstant();
            texts.forEach(t => t.classList.remove("active", "blur"));
          });

          /* ðŸ”¥ INSTANT REMOVE ON CLICK */
          text.addEventListener("click", () => {
            hideImagePreviewInstant();
          });

        });
        /* ---------------- INITIAL ---------------- */
        hideImagePreviewInstant();
        animateTexts(texts);

      });


    script.
      document.addEventListener("DOMContentLoaded", () => {

        gsap.registerPlugin(ScrollTrigger);

        gsap.defaults({
          duration: 0.9,
          ease: "power3.out"
        });

        /* =========================
          GRID IMAGE REVEAL
        ========================= */
        function animateGridImages() {
          gsap.utils.toArray(".main-grid-img img").forEach(img => {
            gsap.from(img, {
              scrollTrigger: {
                trigger: img,
                start: "top 85%"
              },
              scale: 1.1,
              opacity: 0
            });
          });
        }

        /* =========================
          GRID TEXT REVEAL
        ========================= */
        function animateGridText() {
          gsap.utils.toArray(".card-title, .card-desc").forEach(el => {
            gsap.from(el, {
              scrollTrigger: {
                trigger: el,
                start: "top 85%"
              },
              y: 40,
              opacity: 0
            });
          });
        }

        /* =========================
          REFRESH ALL ANIMATIONS
        ========================= */
        function refreshAnimations() {
          ScrollTrigger.getAll().forEach(st => st.kill());
          animateGridImages();
          animateGridText();
          ScrollTrigger.refresh();
        }

        /* =========================
          INITIAL LOAD
        ========================= */
        refreshAnimations();

        /* =========================
          VIEW TOGGLE
        ========================= */
        const gridBtn = document.getElementById("gridBtn");
        const listBtn = document.getElementById("listBtn");

        if (gridBtn && listBtn) {
          gridBtn.addEventListener("click", () => {
            setTimeout(refreshAnimations, 50);
          });

          listBtn.addEventListener("click", () => {
            setTimeout(refreshAnimations, 50);
          });
        }

      });

    //- Page animation
    script.
      gsap.registerPlugin(ScrollTrigger);

      gsap.defaults({
        duration: 1,
        ease: "power3.out"
      });

      // =========================
      // HERO ANIMATION
      // =========================
      const heroTL = gsap.timeline();
      heroTL
        .from(".image-container-unique img", { scale: 1.2, opacity: 0, duration: 1.4 })
        .from(".animate-text-unique", { y: 80, opacity: 0, stagger: 0.2 }, "-=0.8")
        .from(".banner-inner-unique ", { y: 60, opacity: 0, stagger: 0.2 }, "-=0.6");

      // =========================
      // TEXT REVEAL ON SCROLL
      // =========================
      gsap.utils.toArray(" h3, .card-title, .card-desc , img").forEach(el => {
        gsap.from(el, {
          scrollTrigger: {
            trigger: el,
            start: "top 70%"
          },
          y: 40,
          opacity: 0
        });
      });

      ScrollTrigger.refresh();
      


    script.
      const gridInner = document.querySelector(".grid-inner");

      gridBtn.addEventListener("click", () => {
        if (gridInner) {
          gridInner.classList.add("active");
        }
      });

      listBtn.addEventListener("click", () => {
        if (gridInner) {
          gridInner.classList.remove("active");
        }
      });
 
       