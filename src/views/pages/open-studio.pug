extends ../layout

block content
  .studio-main-outer
    .page-wrapper(
        data-morning=studioImages && studioImages.data && studioImages.data.morning ? studioImages.data.morning.url : ''
        data-afternoon=studioImages && studioImages.data && studioImages.data.afternoon ? studioImages.data.afternoon.url : ''
        data-evening=studioImages && studioImages.data && studioImages.data.evening ? studioImages.data.evening.url : ''
        data-night=studioImages && studioImages.data && studioImages.data.night ? studioImages.data.night.url : ''
    )
      .details
        .details-item
          span.label LOCATION
          | SAIGON
        .details-item
          span.label TIME
          span#saigonTime 7:00 AM


    .work-outer.open-outer
      .container
        .work-flex.open-flex
          .toggle
            button#gridBtn.active Grid
            button#listBtn List

        // ================= GRID VIEW =================
        #gridView.grid.active.inner-grid-open
          -
            const gapPattern = ['gap-right', 'gap-center', 'gap-none', 'gap-right'];
          each item, index in workItems
            .card(class=gapPattern[index % gapPattern.length])
              if item.data.thumbnail
                .main-grid-img
                  img(src=item.data.thumbnail.url, alt=item.data.title)
              .card-title= item.data.title
              .card-desc= item.data.short_description

        // ================= IMAGE PREVIEW =================
        #imagePreview

        // ================= LIST VIEW =================
        #listView.list
          .canvas
            each item in workItems
              .text(
                data-image=item.data.thumbnail ? item.data.thumbnail.url : ''
              )= item.data.title

    script(src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.13.0/gsap.min.js")
    script(src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.13.0/ScrollTrigger.min.js")

    script.
      document.addEventListener("DOMContentLoaded", () => {

        gsap.registerPlugin(ScrollTrigger);

        const gridBtn = document.getElementById("gridBtn");
        const listBtn = document.getElementById("listBtn");
        const gridView = document.getElementById("gridView");
        const listView = document.getElementById("listView");
        const imagePreview = document.getElementById("imagePreview");
        const texts = document.querySelectorAll(".text");
        const cards = document.querySelectorAll(".card");

        /* ================= SAIGON REAL TIME ================= */
        const timeEl = document.getElementById("saigonTime");

        function updateSaigonTime() {
          if (!timeEl) return;

          const now = new Date();

          const formatter = new Intl.DateTimeFormat("en-US", {
            timeZone: "Asia/Ho_Chi_Minh",
            hour: "numeric",
            minute: "2-digit",
            hour12: true
          });

          timeEl.textContent = formatter.format(now);
        }

        // initial run
        updateSaigonTime();

        // update every minute (real-time feel)
        setInterval(updateSaigonTime, 60 * 1000);

        /* ================= OPEN STUDIO BACKGROUND ================= */
        const pageWrapper = document.querySelector(".page-wrapper");

        function updateStudioBackground() {
          if (!pageWrapper) return;

          const now = new Date();

          // Saigon hour (24h format)
          const hour = new Intl.DateTimeFormat("en-US", {
            timeZone: "Asia/Ho_Chi_Minh",
            hour: "numeric",
            hour12: false
          }).format(now);

          let bgImage = "";

          if (hour >= 5 && hour < 12) {
            bgImage = pageWrapper.dataset.morning;
          } else if (hour >= 12 && hour < 17) {
            bgImage = pageWrapper.dataset.afternoon;
          } else if (hour >= 17 && hour < 20) {
            bgImage = pageWrapper.dataset.evening;
          } else {
            bgImage = pageWrapper.dataset.night;
          }

          if (!bgImage) return;

          pageWrapper.style.backgroundImage = `url(${bgImage})`;
          pageWrapper.style.backgroundSize = "cover";
          pageWrapper.style.backgroundPosition = "center";
          pageWrapper.style.backgroundRepeat = "no-repeat";
        }

        // initial run
        updateStudioBackground();

        // update every minute (optional but nice)
        setInterval(updateStudioBackground, 60 * 1000);



        /* ================= IMAGE HIDE (INSTANT) ================= */
        function hideImagePreviewInstant() {
          gsap.killTweensOf(imagePreview);
          gsap.set(imagePreview, {
            opacity: 0,
            scale: 0.95
          });
          imagePreview.style.backgroundImage = "none";
        }

        /* ================= GRID ANIMATION ================= */
        function animateGrid() {
          gsap.fromTo(
            cards,
            { y: 40, opacity: 0 },
            { y: 0, opacity: 1, duration: 0.8, stagger: 0.1, ease: "power3.out" }
          );
        }

        /* ================= LIST ANIMATION ================= */
        function animateList() {
          gsap.fromTo(
            texts,
            { y: 20, opacity: 0 },
            { y: 0, opacity: 1, duration: 0.8, stagger: 0.08, ease: "power3.out" }
          );
        }

        /* ================= VIEW TOGGLE ================= */
        gridBtn.addEventListener("click", () => {
          gridView.classList.add("active");
          listView.classList.remove("active");
          gridBtn.classList.add("active");
          listBtn.classList.remove("active");

          hideImagePreviewInstant();
          texts.forEach(t => t.classList.remove("active", "blur"));

          animateGrid();
        });

        listBtn.addEventListener("click", () => {
          listView.classList.add("active");
          gridView.classList.remove("active");
          listBtn.classList.add("active");
          gridBtn.classList.remove("active");

          hideImagePreviewInstant();
          animateList();
        });

        /* ================= TEXT POSITIONS (SAME PATTERN) ================= */
        const pattern = [
          { left: 120, top: 70 },
          { left: 120, top: 140 },
          { right: 180, top: 200 },
          { left: 360, top: 260 },
          { left: 120, top: 330 },
          { right: 240, top: 390 },
          { left: 260, top: 460 }
        ];

        texts.forEach((text, index) => {
          const pos = pattern[index % pattern.length];
          text.style.top = `${pos.top + Math.floor(index / pattern.length) * 520}px`;

          if (pos.left !== undefined) {
            text.style.left = `${pos.left}px`;
            text.style.right = "auto";
          }

          if (pos.right !== undefined) {
            text.style.right = `${pos.right}px`;
            text.style.left = "auto";
          }
        });

        /* ================= LIST HOVER IMAGE ================= */
        texts.forEach(text => {
          const img = text.dataset.image;

          text.addEventListener("mouseenter", () => {
            texts.forEach(t => {
              t.classList.add("blur");
              t.classList.remove("active");
            });

            text.classList.add("active");
            text.classList.remove("blur");

            if (!img) return;

            imagePreview.style.backgroundImage = `url(${img})`;

            gsap.set(imagePreview, {
              left: "50%",
              top: "50%",
              x: "-50%",
              y: "-50%",
              opacity: 1,
              scale: 1
            });
          });

          text.addEventListener("mouseleave", () => {
            hideImagePreviewInstant();
            texts.forEach(t => t.classList.remove("active", "blur"));
          });

          text.addEventListener("click", hideImagePreviewInstant);
        });

        /* ================= EXTRA SAFETY ================= */
        listView.addEventListener("mouseleave", hideImagePreviewInstant);
        imagePreview.addEventListener("mouseleave", hideImagePreviewInstant);

        /* ================= INITIAL ================= */
        hideImagePreviewInstant();
        animateGrid();
      });
